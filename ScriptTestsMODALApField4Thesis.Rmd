---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.6.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import numpy as np
import glob
import matplotlib.pyplot as plt
from qbdataio import MultiHornMain
from CSFPA_dataIO import makemeshgrid, IntensityCalcRAW
from scipy.interpolate import griddata
from scipy.signal import chirp, find_peaks, peak_widths
import scipy
```

```{python}
#oldtabfield = np.loadtxt('/home/james/graspfiles/tabsourcefiles/Horn_Clover12b_150GHzSM_Coherent_NF__with_ORTH_grdfileXPOLONLY.grd', skiprows=8).T
oldtabfield = np.loadtxt('/media/james/DATA/LaptopFiles/graspfiles/tabsourcefiles/Horn_Clover12b_150GHzSM_Coherent_NF__with_ORTH_grdfileXPOLONLY.grd', skiprows=7).T
print(oldtabfield.shape)
#davetabfield = np.loadtxt('/home/james/graspfiles/tabsourcefiles/150tabsourcedave.grd', skiprows=8).T
davetabfield = np.loadtxt('/media/james/DATA/MODALhorn/DavesVersion/150hornoutput.dat', skiprows=1).T
print(davetabfield.shape)
#mysource = np.loadtxt('/media/james/DATA/MODALhorn/150 horn output.dat', skiprows=1).T
mysource = np.loadtxt('/media/james/DATA/MODALhorn2/150hornoutput1123.dat', skiprows=1).T
print(mysource.shape)
```

```{python}
#convert donnys ap field to .dat / .qb
#do calculations for amp and phase

ampXvar = np.sqrt(oldtabfield[0,:]**2 + oldtabfield[1,:]**2) 

phaXvar = np.arctan2(oldtabfield[1,:],oldtabfield[0,:])

ampYvar = np.sqrt(oldtabfield[2,:]**2 + oldtabfield[3,:]**2) 

phaYvar = np.arctan2(oldtabfield[3,:],oldtabfield[2,:])

ampZvar = np.sqrt(oldtabfield[4,:]**2 + oldtabfield[5,:]**2) 

phaZvar = np.arctan2(oldtabfield[5,:],oldtabfield[4,:])

print(ampXvar.shape)

xvals = np.linspace(-6.167E-00, 6.167E-00, 101)
yvals = np.linspace(-6.167E-00, 6.167E-00, 101)
X,Y = np.meshgrid(xvals, yvals)
pts = np.c_[Y.ravel(), X.ravel()]


print(ampXvar.shape, X.shape, pts.shape)
#print(pts[:,0].shape, min(abs(pts[:,0])))

plt.plot(pts[:,1][np.where(pts[:,0] == 0)], ampXvar[np.where(pts[:,0] == 0)], '.')
plt.plot(pts[:,0][np.where(pts[:,1] == 0)], ampXvar[np.where(pts[:,1] == 0)], '.')
plt.plot(pts[:,1][np.where(pts[:,0] == pts[:,1])], ampXvar[np.where(pts[:,0] == pts[:,1])], '.')
```

```{python}
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 22}

plt.rc('font', **font)
plt.figure(figsize=(12,10))

plt.subplot(2,2,1)
plt.scatter(davetabfield[2,:], davetabfield[3,:], c=davetabfield[4,:])
plt.title('Daves File col4')
plt.colorbar()
plt.subplot(2,2,2)
plt.scatter(davetabfield[2,:], davetabfield[3,:], c=davetabfield[5,:])
plt.title('Daves File col5')
plt.colorbar()
plt.subplot(2,2,3)
plt.scatter(davetabfield[2,:], davetabfield[3,:], c=davetabfield[6,:])
plt.title('Daves File col6')
plt.colorbar()
plt.subplot(2,2,4)
plt.scatter(davetabfield[2,:], davetabfield[3,:], c=davetabfield[7,:])
plt.title('Daves File col7')
plt.colorbar()


plt.figure(figsize=(12,10))

plt.subplot(2,2,1)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[4,:])
plt.title('My Source')
plt.colorbar()
plt.subplot(2,2,2)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[5,:])
plt.title('My Source')
plt.colorbar()
plt.subplot(2,2,3)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[6,:])
plt.title('My Source')
plt.colorbar()
plt.subplot(2,2,4)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[7,:])
plt.title('My Source')
plt.colorbar()

#now normalise and do difference
mys = mysource[4,:]/max(mysource[4,:])
ds = davetabfield[4,:]/max(davetabfield[4,:])
print(mys.shape, ds.shape)

plt.figure(figsize=(12,10))

plt.scatter(mysource[2,:], mysource[3,:], c=mys-ds)
plt.title('Difference')
plt.colorbar()

```

```{python}
colors = plt.rcParams["axes.prop_cycle"].by_key()["color"]
print(colors)
r = np.sqrt(pts[:,0][np.where(pts[:,1] == pts[:,0])]**2 + pts[:,1][np.where(pts[:,1] == pts[:,0])]**2)
print(r.shape, (mysource[4,:][np.where(mysource[3,:] == mysource[2,:])]/max(mysource[4,:])).shape)
```

```{python}
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 22}

plt.rc('font', **font)
plt.figure(figsize=(16,8))
#x cuts
plt.plot(pts[:,0][np.where(pts[:,1] == 0)], ampXvar[np.where(pts[:,1] == 0)]/max(ampXvar), color='#ff7f0e', 
         linewidth=3, label=r'Scatter 0$\degree$ cut')
plt.plot(davetabfield[2,:][np.where(davetabfield[3,:]==0)], 
         davetabfield[4,:][np.where(davetabfield[3,:]==0)]/max(davetabfield[4,:]), '--', color='#2ca02c',
         linewidth=3, label='MODAL 0$\degree$ cut')
plt.plot(mysource[2,:][np.where(mysource[3,:]==0)], 
         mysource[4,:][np.where(mysource[3,:]==0)]/max(mysource[4,:]), ':', color='#d62728', 
         linewidth=3, label='MODAL v2 0$\degree$ cut')

#45 deg cuts
# plt.plot(pts[:,0][np.where(pts[:,1] == pts[:,0])], ampXvar[np.where(pts[:,1] == pts[:,0])]/max(ampXvar), 
#          color='#7f7f7f', linewidth=3, label='Donnys Scatter 45 cut')
plt.plot(r, ampXvar[np.where(pts[:,1] == pts[:,0])]/max(ampXvar), 
         color='#9467bd', linewidth=3, label='Scatter 45$\degree$ cut')

plt.plot(r, 
         davetabfield[4,:][np.where(davetabfield[3,:] == davetabfield[2,:])]/max(davetabfield[4,:]), 
         '--', color='#8c564b', linewidth=3, label='MODAL 45$\degree$ cut')
plt.plot(r, 
         mysource[4,:][np.where(mysource[3,:] == mysource[2,:])]/max(mysource[4,:]), ':', color='#e377c2', 
         linewidth=3, label='MODAL v2 45$\degree$ cut')

#ycuts
plt.plot(pts[:,1][np.where(pts[:,0] == 0)], ampXvar[np.where(pts[:,0] == 0)]/max(ampXvar), color='#7f7f7f', 
         linewidth=3, label='Scatter 90$\degree$ cut')
plt.plot(davetabfield[3,:][np.where(davetabfield[2,:]==0)], 
         davetabfield[4,:][np.where(davetabfield[2,:]==0)]/max(davetabfield[4,:]), '--', color='#bcbd22',
         linewidth=3, label='MODAL 90$\degree$ cut')
plt.plot(mysource[3,:][np.where(mysource[2,:]==0)], 
         mysource[4,:][np.where(mysource[2,:]==0)]/max(mysource[4,:]), ':', color='#17becf', 
         linewidth=3, label='MODAL v2 90$\degree$ cut')

plt.grid(True)
plt.ylabel("Normalised Intenisty (dB)")
plt.xlabel('Aperture Field (mm)')
plt.title('Corrugated Horn Aperture Field')
plt.xlim(0,6.5)
plt.legend(loc='lower left')
#plt.savefig("/home/james/OneDrive/ThesisPlots/apfield.png", bbox_inches='tight', facecolor='white')


```

```{python}
"""try this plot in a 3x1 arrangement"""
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 20}
plt.rc('font', **font)
plt.figure(figsize=(16,18))

plt.subplot(3,1,1 )

plt.plot(pts[:,0][np.where(pts[:,1] == 0)], ampXvar[np.where(pts[:,1] == 0)]/max(ampXvar), color='#ff7f0e', 
         linewidth=3, label=r'Scatter 0$\degree$ cut')
plt.plot(davetabfield[2,:][np.where(davetabfield[3,:]==0)], 
         davetabfield[4,:][np.where(davetabfield[3,:]==0)]/max(davetabfield[4,:]), color='#2ca02c',
         linewidth=3, label='MODAL 0$\degree$ cut')
plt.plot(mysource[2,:][np.where(mysource[3,:]==0)], 
         mysource[4,:][np.where(mysource[3,:]==0)]/max(mysource[4,:]), color='#d62728', 
         linewidth=3, label='MODAL 0$\degree$ cut (frequency model)')

plt.grid(True)
plt.ylabel("Normalised Intenisty (dB)")
plt.xlabel('Aperture Field (mm)')
plt.title('Corrugated Horn Aperture Field 0$\degree$ Cut')
plt.xlim(0,6.5)
plt.legend(loc='lower left')

plt.subplot(3,1,2)
plt.plot(r, ampXvar[np.where(pts[:,1] == pts[:,0])]/max(ampXvar), 
         color='#ff7f0e', linewidth=3, label='Scatter 45$\degree$ cut')
plt.plot(r, 
         davetabfield[4,:][np.where(davetabfield[3,:] == davetabfield[2,:])]/max(davetabfield[4,:]), 
         color='#2ca02c', linewidth=3, label='MODAL 45$\degree$ cut')
plt.plot(r, 
         mysource[4,:][np.where(mysource[3,:] == mysource[2,:])]/max(mysource[4,:]), color='#d62728', 
         linewidth=3, label='MODAL 45$\degree$ cut (frequency model)')
plt.grid(True)
plt.ylabel("Normalised Intenisty (dB)")
plt.xlabel('Aperture Field (mm)')
plt.title('Corrugated Horn Aperture Field 45$\degree$ Cut')
plt.xlim(0,6.5)
plt.legend(loc='lower left')

plt.subplot(3,1,3)
#ycuts
plt.plot(pts[:,1][np.where(pts[:,0] == 0)], ampXvar[np.where(pts[:,0] == 0)]/max(ampXvar), color='#ff7f0e', 
         linewidth=3, label='Scatter 90$\degree$ cut')
plt.plot(davetabfield[3,:][np.where(davetabfield[2,:]==0)], 
         davetabfield[4,:][np.where(davetabfield[2,:]==0)]/max(davetabfield[4,:]), color='#2ca02c',
         linewidth=3, label='MODAL 90$\degree$ cut')
plt.plot(mysource[3,:][np.where(mysource[2,:]==0)], 
         mysource[4,:][np.where(mysource[2,:]==0)]/max(mysource[4,:]), color='#d62728', 
         linewidth=3, label='MODAL 90$\degree$ cut (frequency model)')
plt.grid(True)
plt.ylabel("Normalised Intenisty (dB)")
plt.xlabel('Aperture Field (mm)')
plt.title('Corrugated Horn Aperture Field 90$\degree$ Cut')
plt.xlim(0,6.5)
plt.legend(loc='lower left')

plt.tight_layout()
#plt.savefig("/home/james/OneDrive/ThesisPlots/apfield3x1.png", bbox_inches='tight', facecolor='white')
```

```{python}
"""now load data for spherical far field cut"""
#donnys scatter model
scat0deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/scatter_spherical_0deg.cut', 
                      skiprows=6, delimiter=',').T
scat45deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/scatter_spherical_45deg.cut', 
                      skiprows=6, delimiter=',').T
scat90deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/scatter_spherical_90deg.cut', 
                      skiprows=6, delimiter=',').T
#daves modal
modal0deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/MODAL_spherical_0deg.cut', 
                      skiprows=6, delimiter=',').T
modal45deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/MODAL_spherical_45deg.cut', 
                      skiprows=6, delimiter=',').T
modal90deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/MODAL_spherical_90deg.cut', 
                      skiprows=6, delimiter=',').T
#myversion of daves
mymodal0deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/myMODALv2_spherical_0deg.cut', 
                      skiprows=6, delimiter=',').T
mymodal45deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/myMODALv2_spherical_45deg.cut', 
                      skiprows=6, delimiter=',').T
mymodal90deg = np.loadtxt('/home/james/OneDrive/SharedFolderUbuntu/myMODALv2_spherical_90deg.cut', 
                      skiprows=6, delimiter=',').T

#gaussian
gauscut = np.loadtxt('/media/james/DATA/LaptopFiles/graspfiles/newsourcetesting/gausscut.cut', skiprows=3, delimiter=',').T

print(scat0deg.shape)
```

```{python}
#plot the spherical far field
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 22}

plt.rc('font', **font)
plt.figure(figsize=(16,8))
#gaussian
plt.plot(gauscut[0,:], gauscut[1,:], label='Gaussian Model', linewidth=3)
#donnys scat
plt.plot(scat0deg[0,:], scat0deg[1,:], label=r'Scatter 0$\degree$ cut', linewidth=3)
plt.plot(scat45deg[0,:], scat45deg[1,:], '--', label=r'Scatter 45$\degree$ cut', linewidth=3)
plt.plot(scat90deg[0,:], scat90deg[1,:], ':', label=r'Scatter 90$\degree$ cut', linewidth=3)
#daves modal
plt.plot(modal0deg[0,:], modal0deg[1,:], label=r'Scatter 0$\degree$ cut', linewidth=3)
plt.plot(modal45deg[0,:], modal45deg[1,:], '--', label=r'Scatter 45$\degree$ cut', linewidth=3)
plt.plot(modal45deg[0,:], modal45deg[1,:], ':',label=r'Scatter 90$\degree$ cut', linewidth=3)
#my modal
plt.plot(mymodal0deg[0,:], mymodal0deg[1,:], label=r'Scatter 0$\degree$ cut', linewidth=3)
plt.plot(mymodal45deg[0,:], mymodal45deg[1,:], '--', label=r'Scatter 45$\degree$ cut', linewidth=3)
plt.plot(mymodal90deg[0,:], mymodal90deg[1,:], ':', label=r'Scatter 90$\degree$ cut', linewidth=3)

plt.legend(loc='upper right')
plt.grid(True)
plt.ylabel("Intenisty (dB)")
plt.xlabel(r'Angle $\theta$ ($^\circ$)')
plt.title('Source Comparison 200 mm Spherical Cut')
plt.xlim(0,90)
plt.ylim(-85, -31)
```

```{python}
"""try this plot in a 3x1 arrangement"""
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 20}
plt.rc('font', **font)
plt.figure(figsize=(16,18))

plt.subplot(3,1,1 )

#gaussian
plt.plot(gauscut[0,:], gauscut[1,:], label='Gaussian model', linewidth=3)
#0deg
plt.plot(scat0deg[0,:], scat0deg[1,:], label=r'Scatter 0$\degree$ cut', linewidth=3)
plt.plot(modal0deg[0,:], modal0deg[1,:], label=r'MODAL 0$\degree$ cut', linewidth=3)
plt.plot(mymodal0deg[0,:], mymodal0deg[1,:], label=r'MODAL 0$\degree$ cut (frequency model)', linewidth=3)

plt.legend(loc='upper right')
plt.grid(True)
plt.ylabel("Intenisty (dB)")
plt.xlabel(r'Angle $\theta$ ($^\circ$)')
plt.title('Source Comparison 200 mm Spherical 0$\degree$ Cut')
plt.xlim(0,90)
plt.ylim(-85, -31)

plt.subplot(3,1,2)
#gaussian
plt.plot(gauscut[0,:], gauscut[1,:], label='Gaussian model', linewidth=3)
#45deg
plt.plot(scat45deg[0,:], scat45deg[1,:], label=r'Scatter 45$\degree$ cut', linewidth=3)
plt.plot(modal45deg[0,:], modal45deg[1,:], label=r'MODAL 45$\degree$ cut', linewidth=3)
plt.plot(mymodal45deg[0,:], mymodal45deg[1,:], label=r'MODAL 45$\degree$ cut (frequency model)', linewidth=3)
plt.legend(loc='upper right')
plt.grid(True)
plt.ylabel("Intenisty (dB)")
plt.xlabel(r'Angle $\theta$ ($^\circ$)')
plt.title('Source Comparison 200 mm Spherical 45$\degree$ Cut')
plt.xlim(0,90)
plt.ylim(-85, -31)

plt.subplot(3,1,3)
#gaussian
plt.plot(gauscut[0,:], gauscut[1,:], label='Gaussian model', linewidth=3)
#ycuts
#90deg
plt.plot(scat90deg[0,:], scat90deg[1,:], label=r'Scatter 90$\degree$ cut', linewidth=3)
plt.plot(modal45deg[0,:], modal45deg[1,:],label=r'MODAL 90$\degree$ cut', linewidth=3)
plt.plot(mymodal90deg[0,:], mymodal90deg[1,:], label=r'MODAL 90$\degree$ cut (frequency model)', linewidth=3)
plt.legend(loc='upper right')
plt.grid(True)
plt.ylabel("Intenisty (dB)")
plt.xlabel(r'Angle $\theta$ ($^\circ$)')
plt.title('Source Comparison 200 mm Spherical 90$\degree$ Cut')
plt.xlim(0,90)
plt.ylim(-85, -31)

plt.tight_layout()
#plt.savefig("/home/james/OneDrive/ThesisPlots/spherical3x1.png", bbox_inches='tight', facecolor='white')
```

```{python}
"""here show the aperture field from MODAL"""

plt.figure(figsize=(14,11))

plt.subplot(2,2,1)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[4,:])
plt.title('Amplitude (X)')
plt.colorbar(label='dB')
plt.xlabel('Aperture Field X (mm)')
plt.ylabel('Aperture Field Y (mm)')

plt.subplot(2,2,2)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[5,:])
plt.title('Phase (X)')
plt.colorbar(label='Hz')
plt.xlabel('Aperture Field X (mm)')
plt.ylabel('Aperture Field Y (mm)')

plt.subplot(2,2,3)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[6,:])
plt.title('Amplitude (Y)')
plt.colorbar(label='dB')
plt.xlabel('Aperture Field X (mm)')
plt.ylabel('Aperture Field Y (mm)')

plt.subplot(2,2,4)
plt.scatter(mysource[2,:], mysource[3,:], c=mysource[7,:])
plt.title('Phase (Y)')
plt.colorbar(label='Hz')
plt.xlabel('Aperture Field X (mm)')
plt.ylabel('Aperture Field Y (mm)')

plt.axis('equal')

plt.tight_layout()
#plt.savefig("/home/james/OneDrive/ThesisPlots/modalapfieldexample.png", bbox_inches='tight', facecolor='white')
#plt.savefig("/home/james/OneDrive/Thesis/Figures/figsc35/modalapfieldexample.png", bbox_inches='tight', facecolor='white')
```

```{python}
"""from here I will use the script davetabsourcehorncombinations & TES-integration-refactor
to convert my grasp files to the modal format
comment out conversion lines later"""
from CSFPA_dataIO import *

inrep = '/home/james/GRASPdata/MyTabSourceFIModel/150GHz/GRASPfiles/'
outrep = '/home/james/GRASPdata/MyTabSourceFIModel/150GHz/MODALfiles/'

#MultiHornMain(inrep, outrep)
```

```{python}
"""load the MODAL files"""
qbrep = '/home/james/GRASPdata/MyTabSourceFIModel/150GHz/MODALfiles/'
files = sorted(glob.glob(qbrep+'*.qb'))
print('read', len(files), 'files')

#define the TD and FI - remember the weird solution to TD numbers 1-64!
FIhorns = np.linspace(1,400,400, dtype=int)

tdrow1 = np.linspace(120, 127, 8, dtype=int)
tdrow2 = np.linspace(142, 149, 8, dtype=int)
tdrow3 = np.linspace(164, 171, 8, dtype=int)
tdrow4 = np.linspace(186, 193, 8, dtype=int)
tdrow5 = np.linspace(208, 215, 8, dtype=int)
tdrow6 = np.linspace(230, 237, 8, dtype=int)
tdrow7 = np.linspace(252, 259, 8, dtype=int)
tdrow8 = np.linspace(274, 281, 8, dtype=int)
TDhorns = np.concatenate((tdrow1, tdrow2, tdrow3, tdrow4, tdrow5, tdrow6, tdrow7, tdrow8))
#TDhorns.extend(tdrow1, tdrow2)
print(TDhorns.shape, FIhorns.shape)

#example baseline
baseline = [120, 127]
print(baseline)
```

```{python}
"""add the relevant horns to be added eventually we could save every possible combination
can choose, baseline, TD, FI"""
#load the files in the rep 
#load a sample file just to grab headers for later
data = pd.read_csv(qbrep+'FP_planar_grid_horn'+str(100)+'_150_GHz_Mstyle.qb', sep='\t')
#print(data)

addimx = np.zeros(len(data['Rex']))
addrex = np.zeros(len(data['Rex']))
addrey = np.zeros(len(data['Rex']))
addimy = np.zeros(len(data['Rex']))

#here we loop through the chosen config, baseline, load the 'qb' files
#and add the instensities

#baseline, TDhorns, FIhorns all interchangeable here
cnt = 0
for horn in FIhorns:
    
    print(qbrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
    file = qbrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
    data = pd.read_csv(file, sep='\t')
    print(data.shape)
    
    #add the relevant compnents to an array
    addrex = np.vstack((addrex, data['Rex']))
    addimx = np.vstack((addimx, data['Imx']))
    addrey = np.vstack((addrey, data['Rey']))
    addimy = np.vstack((addimy, data['Imy']))
    
    cnt+=1
    
#add / flatten the array
addrex = np.sum(addrex.T, axis=1, dtype=float)
addimx = np.sum(addimx.T, axis=1, dtype=float)
addrey = np.sum(addrey.T, axis=1, dtype=float)
addimy = np.sum(addimy.T, axis=1, dtype=float)
#convert to mag and phase... why didn't i just load the mag and phase...?
MagX = np.sqrt(addrex**2 + addimx**2)
PhaX = np.arctan2(addimx, addrex)
MagY = np.sqrt(addrey**2 + addimy**2)
PhaY = np.arctan2(addimy, addrey)
#convert mag phase to intensity
itx = (MagX*np.cos(PhaX))**2 + (MagX*np.sin(PhaX))**2
ity = (MagY*np.cos(PhaY))**2 + (MagY*np.sin(PhaY))**2
it = itx[:] + ity[:]
print("it shape: ", it.shape, cnt)
```

```{python}
"""plot all the focal plane data, will need to integrate on bolometer
This is for MY Model..."""
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 22}

plt.rc('font', **font)
plt.figure(figsize=(16,13))

plt.scatter(data['Xpos'], data['Ypos'], c=it/max(it), cmap='gnuplot', marker='.')#, s=1)
plt.axis([-60, 60, -60, 60])
plt.axis('equal')
plt.title("400 Horns on Focal Plane")
plt.xlabel('Focal Plane X (m)')
plt.ylabel('Focal Plane Y (m)')
plt.subplots_adjust(bottom=0.1, right=0.8, top=0.9)
cax = plt.axes([0.825, 0.1, 0.04, 0.8])
plt.colorbar(cax=cax,label="Normalised Intensity (W)", shrink=0.9)

plt.show()
#plt.savefig("/home/james/OneDrive/Thesis/Figures/figsc35/400horn.png", bbox_inches='tight', facecolor='white')
```

```{python}
"""load the MODAL files for daves Model"""
qbrepDAVE = '/home/james/GRASPdata/DavesTabSourceFIModel/MODALfiles/'
files = sorted(glob.glob(qbrepDAVE+'*.qb'))
print('read', len(files), 'files')
```

```{python}
"""add the relevant horns to be added eventually we could save every possible combination
can choose, baseline, TD, FI"""
#load the files in the rep 
#load a sample file just to grab headers for later
data = pd.read_csv(qbrepDAVE+'FP_planar_grid_horn'+str(100)+'_150_GHz_Mstyle.qb', sep='\t')
#print(data)

addimx = np.zeros(len(data['Rex']))
addrex = np.zeros(len(data['Rex']))
addrey = np.zeros(len(data['Rex']))
addimy = np.zeros(len(data['Rex']))

#here we loop through the chosen config, baseline, load the 'qb' files
#and add the instensities

#baseline, TDhorns, FIhorns all interchangeable here
cnt = 0
for horn in FIhorns:
    
    print(qbrepDAVE+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
    file = qbrepDAVE+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
    data = pd.read_csv(file, sep='\t')
    print(data.shape)
    
    #add the relevant compnents to an array
    addrex = np.vstack((addrex, data['Rex']))
    addimx = np.vstack((addimx, data['Imx']))
    addrey = np.vstack((addrey, data['Rey']))
    addimy = np.vstack((addimy, data['Imy']))
    
    cnt+=1
    
#add / flatten the array
addrex = np.sum(addrex.T, axis=1, dtype=float)
addimx = np.sum(addimx.T, axis=1, dtype=float)
addrey = np.sum(addrey.T, axis=1, dtype=float)
addimy = np.sum(addimy.T, axis=1, dtype=float)
#convert to mag and phase... why didn't i just load the mag and phase...?
MagX = np.sqrt(addrex**2 + addimx**2)
PhaX = np.arctan2(addimx, addrex)
MagY = np.sqrt(addrey**2 + addimy**2)
PhaY = np.arctan2(addimy, addrey)
#convert mag phase to intensity
itx = (MagX*np.cos(PhaX))**2 + (MagX*np.sin(PhaX))**2
ity = (MagY*np.cos(PhaY))**2 + (MagY*np.sin(PhaY))**2
itDAVE = itx[:] + ity[:]
print("itDAVE shape: ", itDAVE.shape, cnt)
```

```{python}
"""show example cut"""

def makemeshgrid(psfdata, meshsize):
    x = np.linspace(min(psfdata[0,:]), max(psfdata[0,:]), meshsize)
    y = np.linspace(min(psfdata[1,:]), max(psfdata[1,:]), meshsize)

    X,Y = np.meshgrid(x, y)

    # Interpolate (x,y,z) points [mat] over a normal (x,y) grid [X,Y]
    #   Depending on your "error", you may be able to use other methods
    Z = griddata((psfdata[0,:], psfdata[1,:]), psfdata[2,:], (X,Y), method='nearest')

    #plt.pcolormesh(X,Y,Z)
    #plt.show()
    return Z

meshsize = 301
TDmesh = np.zeros([1, meshsize, meshsize])
TDmesh = makemeshgrid(np.array([data['Xpos'], data['Ypos'], it]), meshsize)
print(TDmesh.shape)
```

```{python}
"""do the example cut"""
font = {'family' : 'normal',
        'weight' : 'normal',
        'size'   : 22}

plt.rc('font', **font)

azmin = min(data['Xpos'])
azmax = max(data['Xpos'])
elmin = min(data['Ypos'])
elmax = max(data['Ypos'])

X = np.linspace(azmin, azmax, 301)
Y = np.linspace(elmax, elmin, 301)

# x0, y0 = 50, 158# These are in _pixel_ coordinates!! in DEGREES
# x1, y1 = 175, 32
x0, y0 = 25, 247# These are in _pixel_ coordinates!! in DEGREES
x1, y1 = 174, 125
x2, y2 = 219, 50

plt.figure(figsize=(16,12))
plt.subplot(1,2,1)
plt.imshow(TDmesh, aspect='equal')
plt.grid(True)
plt.plot([x0, x1], [y0, y1], 'ro-')
plt.plot([x1, x2], [y1, y2], 'bo-')


#x, y = np.linspace(x0, x1, 40), np.linspace(y0, y1, 40)
xr = np.linspace(x0, x2, x2-x0)
#xa, ya = np.linspace(x1, x2, 20), np.linspace(y1, y2, 20)
yi = np.linspace(y0, y1, x1-x0)
yj = np.linspace(y1, y2, x2-x1)

#xr = np.append(x, xa)
yr = np.append(yi, yj)

plt.subplot(1,2,2)
plt.imshow(TDmesh, aspect='equal', extent=[azmin, azmax, elmin, elmax])
plt.grid(True)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')

#degpt = (azmax - azmin)/301
#degpt = (np.rad2deg(np.arctan(max(data['Xpos']))/300e-3) - np.rad2deg(np.arctan(min(data['Xpos']))/300e-3)) /301
#degpt = np.rad2deg(np.arctan( (max(data['Xpos']) - min(data['Xpos'])) /300e-3)) / 301


zi = TDmesh[xr.astype(np.int), yr.astype(np.int)]
zi = scipy.ndimage.map_coordinates(np.transpose(TDmesh), np.vstack((xr,yr)))
azi = np.linspace(X[x0], X[x2], len(zi))
peaks, _ = find_peaks(zi, prominence=2)
results_half = peak_widths(zi, peaks, rel_height=0.5)
print(azi.shape, zi.shape, peaks.shape)
print(results_half)


plt.figure(figsize=(16,8))
plt.plot(azi, zi, label="Cut", lw=4)
plt.plot(azi[peaks], zi[peaks], "x", label="Peaks", mew=5, ms=10)
plt.plot(azi[peaks], results_half[1], '_', mew=5, ms=10, 
     label="fwhm label {:3.3}".format(results_half[0][1]*0.12/301))
plt.plot(azi[peaks], zi[peaks], "x", mew=5, ms=10,
     label="Peak Sep {:3.3}, {:3.3}".
         format(azi[peaks][1]-azi[peaks][0], azi[peaks][1]-azi[peaks][2]))
plt.legend(loc='upper left', fontsize=15)

#this version does a radial calculation for cut
azi = np.linspace(-1*np.sqrt(X[x0]**2+(Y[y0])**2), np.sqrt(X[x2]**2+(Y[y2])**2), len(zi))
peaks, _ = find_peaks(zi, prominence=2)
results_half = peak_widths(zi, peaks, rel_height=0.5)

#normzi
zin = zi/max(zi)
results_half_n = peak_widths(zin, peaks, rel_height=0.5)


plt.figure(figsize=(16,8))
plt.plot(azi, zin, label="Cut", lw=4)
plt.plot(azi[peaks], zin[peaks], "x", label="Peaks", mew=5, ms=10)
plt.plot(azi[peaks], results_half_n[1], '_', mew=5, ms=10, 
     label="fwhm label {:3.3}".format(results_half_n[0][1]*0.12/301))
plt.plot(azi[peaks], zin[peaks], "x", mew=5, ms=10,
     label="Peak Sep {:3.3}, {:3.3}".
         format(azi[peaks][1]-azi[peaks][0], azi[peaks][1]-azi[peaks][2]))

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
```

```{python}
"""plot all the focal plane data, will need to integrate on bolometer
This is for MY Model..."""
"""here show the aperture field from MODAL"""

diff = (it/max(it)) - (itDAVE/max(itDAVE))

# plt.rcParams['figure.figsize'] = [15, 15]
# fig = plt.figure(figsize=(14, 11))
# fig, axes = plt.subplots(nrows=2, ncols=2)
# print(axes.shape)
# im1 = axes[0,0].scatter(data['Xpos'], data['Ypos'], c=it/max(it), cmap='gnuplot', marker='.')#, s=1)
# im2 = axes[0,1].scatter(data['Xpos'], data['Ypos'], c=itDAVE/max(itDAVE), cmap='gnuplot', marker='.')#, s=1)
# im3 = axes[1,0].scatter(data['Xpos'], data['Ypos'], c=diff, cmap='gnuplot', marker='.')#, s=1)
# fig.subplots_adjust(right=0.8)
# cbar_ax = fig.add_axes([0.85, 0.15, 0.05, 0.7])
# fig.colorbar(im3, cax=cbar_ax)

# plt.show()

plt.figure(figsize=(14,11))
plt.subplot(2,2,1)
plt.scatter(data['Xpos'], data['Ypos'], c=it/max(it), cmap='gnuplot', marker='.')#, s=1)
plt.title('Frequency Model')
plt.colorbar(label='Normalised Intensity (W)')
plt.xlabel('Focal Plane X (m)')
plt.ylabel('Focal Plane Y (mm)')

plt.subplot(2,2,2)
plt.scatter(data['Xpos'], data['Ypos'], c=itDAVE/max(itDAVE), cmap='gnuplot', marker='.')#, s=1)
plt.title('Reference Model')
plt.colorbar(label='Normalised Intensity (W)')
plt.xlabel('Focal Plane X (m)')
plt.ylabel('Focal Plane Y (m)')

plt.subplot(2,2,3)
plt.scatter(data['Xpos'], data['Ypos'], c=diff, cmap='copper', marker='.')#, s=1)
plt.title('Difference')
plt.colorbar(label='Normalised Intensity (W)')
plt.xlabel('Focal Plane X (m)')
plt.ylabel('Focal Plane Y (m)')

plt.subplot(2,2,4)
plt.imshow(TDmesh, aspect='equal', extent=[azmin, azmax, elmin, elmax], cmap='gnuplot', vmin=0, vmax=1)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')
plt.colorbar(label='Normalised Intensity (W)')
plt.xlabel('Focal Plane X (m)')
plt.ylabel('Focal Plane Y (m)')
plt.title('Cut Example')
plt.axis('equal')

plt.tight_layout()

#plt.savefig("/home/james/OneDrive/Thesis/Figures/figsc35/2x2FP.png", bbox_inches='tight', facecolor='white')


```

```{python}
"""pretest data"""
print(it.shape, itDAVE.shape)

"""load the MODAL files for daves Model"""
qbrepDAVE = '/home/james/GRASPdata/DavesTabSourceFIModel/MODALfiles/'
filesDAVE = sorted(glob.glob(qbrepDAVE+'*.qb'))
print('read', len(filesDAVE), 'DAVE files')

"""load the MODAL files"""
qbrep = '/home/james/GRASPdata/MyTabSourceFIModel/150GHz/MODALfiles/'
files = sorted(glob.glob(qbrep+'*.qb'))
print('read', len(files), 'My files')

"""load Donnys SCATTER version"""
qbrepDONNY = '/media/james/DATA/LaptopFiles/FIgraspFiles/MODALversions/'
filesDONNY = sorted(glob.glob(qbrepDONNY+'*.qb'))
print('read', len(filesDONNY), 'Donny files')
donnydat = pd.read_csv(filesDONNY[0], sep='\t')
print(donnydat.shape)
donnydat.head()

```

```{python}
"""make donnys intensity data"""
addimx = np.zeros(len(donnydat['Rex']))
addrex = np.zeros(len(donnydat['Rex']))
addrey = np.zeros(len(donnydat['Rex']))
addimy = np.zeros(len(donnydat['Rex']))

#here we loop through the chosen config, baseline, load the 'qb' files
#and add the instensities

#baseline, TDhorns, FIhorns all interchangeable here
cnt = 0
for horn in FIhorns:
    
    print(qbrepDONNY+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
    file = qbrepDONNY+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
    donnydat = pd.read_csv(file, sep='\t')
    print(data.shape)
    
    #add the relevant compnents to an array
    addrex = np.vstack((addrex, donnydat['Rex']))
    addimx = np.vstack((addimx, donnydat['Imx']))
    addrey = np.vstack((addrey, donnydat['Rey']))
    addimy = np.vstack((addimy, donnydat['Imy']))
    
    cnt+=1
    
#add / flatten the array
addrex = np.sum(addrex.T, axis=1, dtype=float)
addimx = np.sum(addimx.T, axis=1, dtype=float)
addrey = np.sum(addrey.T, axis=1, dtype=float)
addimy = np.sum(addimy.T, axis=1, dtype=float)
#convert to mag and phase... why didn't i just load the mag and phase...?
MagX = np.sqrt(addrex**2 + addimx**2)
PhaX = np.arctan2(addimx, addrex)
MagY = np.sqrt(addrey**2 + addimy**2)
PhaY = np.arctan2(addimy, addrey)
#convert mag phase to intensity
itx = (MagX*np.cos(PhaX))**2 + (MagX*np.sin(PhaX))**2
ity = (MagY*np.cos(PhaY))**2 + (MagY*np.sin(PhaY))**2
itDONNY = itx[:] + ity[:]
print("itDONNY shape: ", itDONNY.shape, cnt)
```

```{python}
"""here i should load data for 150GHz, my modal, daves model, donnys, gaussian, all on FP
must use meshgrid which requires the intensity OR maybe the amplitude of each file
try to use dataIO functions intensitycalcraw, makemeshgrid

Now here show the cut for DAVES MODAL horn model"""
from scipy.interpolate import griddata
meshsize = 301
DAVEmesh = np.zeros([1, meshsize, meshsize])
DAVEmesh = makemeshgrid(np.array([data['Xpos'], data['Ypos'], itDAVE]), meshsize)
print(DAVEmesh.shape)


azmin = min(data['Xpos'])
azmax = max(data['Xpos'])
elmin = min(data['Ypos'])
elmax = max(data['Ypos'])

X = np.linspace(azmin, azmax, 301)
Y = np.linspace(elmax, elmin, 301)

# x0, y0 = 50, 158# These are in _pixel_ coordinates!! in DEGREES
# x1, y1 = 175, 32
x0, y0 = 25, 247# These are in _pixel_ coordinates!! in DEGREES
x1, y1 = 174, 125
x2, y2 = 219, 50

plt.figure(figsize=(16,12))
plt.subplot(1,2,1)
plt.imshow(DAVEmesh, aspect='equal')
plt.grid(True)
plt.plot([x0, x1], [y0, y1], 'ro-')
plt.plot([x1, x2], [y1, y2], 'bo-')


#x, y = np.linspace(x0, x1, 40), np.linspace(y0, y1, 40)
xr = np.linspace(x0, x2, x2-x0)
#xa, ya = np.linspace(x1, x2, 20), np.linspace(y1, y2, 20)
yi = np.linspace(y0, y1, x1-x0)
yj = np.linspace(y1, y2, x2-x1)

#xr = np.append(x, xa)
yr = np.append(yi, yj)

plt.subplot(1,2,2)
plt.imshow(DAVEmesh, aspect='equal', extent=[azmin, azmax, elmin, elmax])
plt.grid(True)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')

#degpt = (azmax - azmin)/301
#degpt = (np.rad2deg(np.arctan(max(data['Xpos']))/300e-3) - np.rad2deg(np.arctan(min(data['Xpos']))/300e-3)) /301
#degpt = np.rad2deg(np.arctan( (max(data['Xpos']) - min(data['Xpos'])) /300e-3)) / 301


ziDAVE = DAVEmesh[xr.astype(np.int), yr.astype(np.int)]
ziDAVE = scipy.ndimage.map_coordinates(np.transpose(DAVEmesh), np.vstack((xr,yr)))
aziDAVE = np.linspace(X[x0], X[x2], len(ziDAVE))
peaks, _ = find_peaks(ziDAVE, prominence=2)
results_half = peak_widths(ziDAVE, peaks, rel_height=0.5)
print(aziDAVE.shape, ziDAVE.shape, peaks.shape)
print(results_half)


plt.figure(figsize=(16,8))
plt.plot(aziDAVE, ziDAVE, label="Cut", lw=4)
plt.plot(aziDAVE[peaks], ziDAVE[peaks], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziDAVE[peaks], results_half[1], '_', mew=5, ms=10, 
     label="fwhm dave label {:3.3}".format(results_half[0][1]*0.12/301))
plt.plot(aziDAVE[peaks], ziDAVE[peaks], "x", mew=5, ms=10,
     label="Peak Sep Dave {:3.3}, {:3.3}".
         format(aziDAVE[peaks][1]-aziDAVE[peaks][0], aziDAVE[peaks][1]-aziDAVE[peaks][2]))
plt.legend(loc='upper left', fontsize=15)

#this version does a radial calculation for cut
aziDAVE = np.linspace(-1*np.sqrt(X[x0]**2+(Y[y0])**2), np.sqrt(X[x2]**2+(Y[y2])**2), len(ziDAVE))
peaksDAVE, _ = find_peaks(ziDAVE, prominence=2)
results_half = peak_widths(ziDAVE, peaksDAVE, rel_height=0.5)

#normzi
zinDAVE = ziDAVE/max(ziDAVE)
results_half_n_DAVE = peak_widths(zinDAVE, peaksDAVE, rel_height=0.5)


plt.figure(figsize=(16,8))
plt.plot(aziDAVE, zinDAVE, label="Cut", lw=4)
plt.plot(aziDAVE[peaksDAVE], zinDAVE[peaksDAVE], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziDAVE[peaksDAVE], results_half_n_DAVE[1], '_', mew=5, ms=10, 
     label="fwhm label {:3.3}".format(results_half_n_DAVE[0][1]*0.12/301))
plt.plot(aziDAVE[peaksDAVE], zinDAVE[peaksDAVE], "x", mew=5, ms=10,
     label="Peak Sep {:3.3}, {:3.3}".
         format(aziDAVE[peaksDAVE][1]-aziDAVE[peaksDAVE][0], aziDAVE[peaksDAVE][1]-aziDAVE[peaksDAVE][2]))

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
plt.title('DAVES Model (MODAL)')
```

```{python}
"""here i should load data for 150GHz, my modal, daves model, donnys, gaussian, all on FP
must use meshgrid which requires the intensity OR maybe the amplitude of each file
try to use dataIO functions intensitycalcraw, makemeshgrid

Now here show the cut for DONNYS MODAL horn model"""
from scipy.interpolate import griddata
meshsize = 301
Donnymesh = np.zeros([1, meshsize, meshsize])
Donnymesh = makemeshgrid(np.array([donnydat['Xpos'], donnydat['Ypos'], itDONNY]), meshsize)
print(Donnymesh.shape)


azmin = min(donnydat['Xpos'])
azmax = max(donnydat['Xpos'])
elmin = min(donnydat['Ypos'])
elmax = max(donnydat['Ypos'])

X = np.linspace(azmin, azmax, 301)
Y = np.linspace(elmax, elmin, 301)

# x0, y0 = 50, 158# These are in _pixel_ coordinates!! in DEGREES
# x1, y1 = 175, 32
x0, y0 = 25, 247# These are in _pixel_ coordinates!! in DEGREES
x1, y1 = 174, 125
x2, y2 = 219, 50

plt.figure(figsize=(16,12))
plt.subplot(1,2,1)
plt.imshow(Donnymesh, aspect='equal')
plt.grid(True)
plt.plot([x0, x1], [y0, y1], 'ro-')
plt.plot([x1, x2], [y1, y2], 'bo-')


#x, y = np.linspace(x0, x1, 40), np.linspace(y0, y1, 40)
xr = np.linspace(x0, x2, x2-x0)
#xa, ya = np.linspace(x1, x2, 20), np.linspace(y1, y2, 20)
yi = np.linspace(y0, y1, x1-x0)
yj = np.linspace(y1, y2, x2-x1)

#xr = np.append(x, xa)
yr = np.append(yi, yj)

plt.subplot(1,2,2)
plt.imshow(Donnymesh, aspect='equal', extent=[azmin, azmax, elmin, elmax])
plt.grid(True)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')

#degpt = (azmax - azmin)/301
#degpt = (np.rad2deg(np.arctan(max(data['Xpos']))/300e-3) - np.rad2deg(np.arctan(min(data['Xpos']))/300e-3)) /301
#degpt = np.rad2deg(np.arctan( (max(data['Xpos']) - min(data['Xpos'])) /300e-3)) / 301


ziDONNY = Donnymesh[xr.astype(np.int), yr.astype(np.int)]
ziDONNY = scipy.ndimage.map_coordinates(np.transpose(Donnymesh), np.vstack((xr,yr)))
aziDONNY = np.linspace(X[x0], X[x2], len(ziDONNY))
peaks, _ = find_peaks(ziDONNY, prominence=2)
results_half = peak_widths(ziDONNY, peaks, rel_height=0.5)
print(aziDONNY.shape, ziDONNY.shape, peaks.shape)
print(results_half)
print(aziDONNY[peaks].shape, ziDONNY[1].shape)


plt.figure(figsize=(16,8))
plt.plot(aziDONNY, ziDONNY, label="Cut", lw=4)
plt.plot(aziDONNY[peaks], ziDONNY[peaks], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziDONNY[peaks], results_half[1], '_', mew=5, ms=10, 
     label="fwhm donny label {:3.3}".format(results_half[0][1]*0.12/301))
plt.plot(aziDONNY[peaks], ziDONNY[peaks], "x", mew=5, ms=10,
     label="Peak Sep Dave {:3.3}, {:3.3}".
         format(aziDONNY[peaks][1]-aziDONNY[peaks][0], aziDONNY[peaks][1]-aziDONNY[peaks][2]))
plt.legend(loc='upper left', fontsize=15)

#this version does a radial calculation for cut
aziDONNY = np.linspace(-1*np.sqrt(X[x0]**2+(Y[y0])**2), np.sqrt(X[x2]**2+(Y[y2])**2), len(ziDONNY))
peaksDONNY, _ = find_peaks(ziDONNY, prominence=2)
results_half_DONNY = peak_widths(ziDONNY, peaksDONNY, rel_height=0.5)

#normzi
zinDONNY = ziDONNY/max(ziDONNY)
results_half_n_DONNY = peak_widths(zinDONNY, peaksDONNY, rel_height=0.5)


plt.figure(figsize=(16,8))
plt.plot(aziDONNY, zinDONNY, label="Cut", lw=4)
plt.plot(aziDONNY[peaksDONNY], zinDONNY[peaksDONNY], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziDONNY[peaksDONNY], results_half_n_DONNY[1], '_', mew=5, ms=10, 
     label="fwhm label {:3.3}".format(results_half_n_DONNY[0][1]*0.12/301))
plt.plot(aziDONNY[peaksDONNY], zinDONNY[peaksDONNY], "x", mew=5, ms=10,
     label="Peak Sep {:3.3}, {:3.3}".
         format(aziDONNY[peaksDONNY][1]-aziDONNY[peaksDONNY][0], aziDONNY[peaksDONNY][1]-aziDONNY[peaksDONNY][2]))

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
plt.title('DAVES Model (MODAL)')
```

```{python}
"""load the gaussian version, first need to convert to QB files"""

grep = '/home/james/GRASPdata/MyTabSourceFIModel/Gaussian150GHz/GRASPfiles/'
mrep = '/home/james/GRASPdata/MyTabSourceFIModel/Gaussian150GHz/MODALfiles/'

#MultiHornMain(grep, mrep)



gausfiles = sorted(glob.glob(mrep+'*.qb'))
print('read', len(gausfiles), 'gaussian files')
gausdata = pd.read_csv(gausfiles[0], sep='\t')
print(gausdata.shape)
gausdata.head()
```

```{python}
"""make gaussian intensity data"""
addimx = np.zeros(len(gausdata['Rex']))
addrex = np.zeros(len(gausdata['Rex']))
addrey = np.zeros(len(gausdata['Rex']))
addimy = np.zeros(len(gausdata['Rex']))

#here we loop through the chosen config, baseline, load the 'qb' files
#and add the instensities

#baseline, TDhorns, FIhorns all interchangeable here
cnt = 0
for horn in FIhorns:
    
    print(mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
    file = mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
    gausdata = pd.read_csv(file, sep='\t')
    print(gausdata.shape)
    
    #add the relevant compnents to an array
    addrex = np.vstack((addrex, gausdata['Rex']))
    addimx = np.vstack((addimx, gausdata['Imx']))
    addrey = np.vstack((addrey, gausdata['Rey']))
    addimy = np.vstack((addimy, gausdata['Imy']))
    
    cnt+=1
    
#add / flatten the array
addrex = np.sum(addrex.T, axis=1, dtype=float)
addimx = np.sum(addimx.T, axis=1, dtype=float)
addrey = np.sum(addrey.T, axis=1, dtype=float)
addimy = np.sum(addimy.T, axis=1, dtype=float)
#convert to mag and phase... why didn't i just load the mag and phase...?
MagX = np.sqrt(addrex**2 + addimx**2)
PhaX = np.arctan2(addimx, addrex)
MagY = np.sqrt(addrey**2 + addimy**2)
PhaY = np.arctan2(addimy, addrey)
#convert mag phase to intensity
itx = (MagX*np.cos(PhaX))**2 + (MagX*np.sin(PhaX))**2
ity = (MagY*np.cos(PhaY))**2 + (MagY*np.sin(PhaY))**2
itGAUSS = itx[:] + ity[:]
print("itGAUSS shape: ", itGAUSS.shape, cnt)
```

```{python}
"""Now here show the cut for GAUSSIAN MODAL horn model"""
from scipy.interpolate import griddata
meshsize = 301
GAUSSmesh = np.zeros([1, meshsize, meshsize])
GAUSSmesh = makemeshgrid(np.array([gausdata['Xpos'], gausdata['Ypos'], itGAUSS]), meshsize)
print(GAUSSmesh.shape)


azmin = min(gausdata['Xpos'])
azmax = max(gausdata['Xpos'])
elmin = min(gausdata['Ypos'])
elmax = max(gausdata['Ypos'])

X = np.linspace(azmin, azmax, 301)
Y = np.linspace(elmax, elmin, 301)

# x0, y0 = 50, 158# These are in _pixel_ coordinates!! in DEGREES
# x1, y1 = 175, 32
x0, y0 = 25, 247# These are in _pixel_ coordinates!! in DEGREES
x1, y1 = 174, 125
x2, y2 = 219, 50

plt.figure(figsize=(16,12))
plt.subplot(1,2,1)
plt.imshow(GAUSSmesh, aspect='equal')
plt.grid(True)
plt.plot([x0, x1], [y0, y1], 'ro-')
plt.plot([x1, x2], [y1, y2], 'bo-')


#x, y = np.linspace(x0, x1, 40), np.linspace(y0, y1, 40)
xr = np.linspace(x0, x2, x2-x0)
#xa, ya = np.linspace(x1, x2, 20), np.linspace(y1, y2, 20)
yi = np.linspace(y0, y1, x1-x0)
yj = np.linspace(y1, y2, x2-x1)

#xr = np.append(x, xa)
yr = np.append(yi, yj)

plt.subplot(1,2,2)
plt.imshow(GAUSSmesh, aspect='equal', extent=[azmin, azmax, elmin, elmax])
plt.grid(True)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')

#degpt = (azmax - azmin)/301
#degpt = (np.rad2deg(np.arctan(max(data['Xpos']))/300e-3) - np.rad2deg(np.arctan(min(data['Xpos']))/300e-3)) /301
#degpt = np.rad2deg(np.arctan( (max(data['Xpos']) - min(data['Xpos'])) /300e-3)) / 301


ziGAUSS = GAUSSmesh[xr.astype(np.int), yr.astype(np.int)]
ziGAUSS = scipy.ndimage.map_coordinates(np.transpose(GAUSSmesh), np.vstack((xr,yr)))
aziGAUSS = np.linspace(X[x0], X[x2], len(ziGAUSS))
peaksGAUSS, _ = find_peaks(ziDONNY, prominence=2)
results_half_GAUSS = peak_widths(ziGAUSS, peaksGAUSS, rel_height=0.5)
print(aziGAUSS.shape, ziGAUSS.shape, peaksGAUSS.shape)
print(results_half_GAUSS)
print(aziGAUSS[peaks].shape, ziGAUSS[1].shape)


plt.figure(figsize=(16,8))
plt.plot(aziGAUSS, ziDONNY, label="Cut", lw=4)
plt.plot(aziGAUSS[peaksGAUSS], ziGAUSS[peaksGAUSS], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziGAUSS[peaksGAUSS], results_half_GAUSS[1], '_', mew=5, ms=10, 
     label="fwhm GAUSSIAN label {:3.3}".format(results_half_GAUSS[0][1]*0.12/301))
plt.plot(aziGAUSS[peaksGAUSS], ziGAUSS[peaksGAUSS], "x", mew=5, ms=10,
     label="Peak Sep Dave {:3.3}, {:3.3}".
         format(aziGAUSS[peaksGAUSS][1]-aziGAUSS[peaksGAUSS][0], aziGAUSS[peaksGAUSS][1]-aziGAUSS[peaksGAUSS][2]))
plt.legend(loc='upper left', fontsize=15)

#this version does a radial calculation for cut
aziGAUSS = np.linspace(-1*np.sqrt(X[x0]**2+(Y[y0])**2), np.sqrt(X[x2]**2+(Y[y2])**2), len(ziGAUSS))
peaksGAUSS, _ = find_peaks(ziGAUSS, prominence=2)
results_half_GAUSS = peak_widths(ziGAUSS, peaksGAUSS, rel_height=0.5)

#normzi
zinGAUSS = ziGAUSS/max(ziGAUSS)
results_half_n_GAUSS = peak_widths(zinGAUSS, peaksGAUSS, rel_height=0.5)


plt.figure(figsize=(16,8))
plt.plot(aziGAUSS, zinGAUSS, label="Cut", lw=4)
plt.plot(aziGAUSS[peaksGAUSS], zinGAUSS[peaksGAUSS], "x", label="Peaks", mew=5, ms=10)
plt.plot(aziGAUSS[peaksGAUSS], results_half_n_DONNY[1], '_', mew=5, ms=10, 
     label="fwhm label {:3.3}".format(results_half_n_GAUSS[0][1]*0.12/301))
plt.plot(aziGAUSS[peaksGAUSS], zinGAUSS[peaksGAUSS], "x", mew=5, ms=10,
     label="Peak Sep {:3.3}, {:3.3}".
         format(aziGAUSS[peaksGAUSS][1]-aziGAUSS[peaksGAUSS][0], aziGAUSS[peaksGAUSS][1]-aziGAUSS[peaksGAUSS][2]))

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
plt.title('GAUSSIAN Model (MODAL)')
```

```{python}
colors = plt.rcParams["axes.prop_cycle"].by_key()["color"]
print(colors)
#look at color codes
```

```{python}
"""now collect all the data/plots"""

plt.figure(figsize=(16,8))
#keep blue for gaussian...
plt.plot(aziGAUSS, zinGAUSS, label="Gaussian Cut", lw=4)
#MINE
plt.plot(azi, zin, color='#ff7f0e', label="Frequency Model Cut", lw=4)

#DAVE
plt.plot(aziDAVE, zinDAVE, ':', color='#2ca02c', label="MODAL Model Cut", lw=3)

#donny
plt.plot(aziDONNY, zinDONNY, '-.', color='#d62728', label="SCATTER Model Cut", lw=2)

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
plt.title('Aperture Field Models on Focal Plane')
plt.grid(True)

```

```{python}
"""now collect all the data/plots"""

plt.figure(figsize=(16,8))
#keep blue for gaussian...
plt.plot(aziGAUSS, zinGAUSS, label="Gaussian Cut", lw=4)
#MINE
plt.plot(azi, zin, color='#ff7f0e', label="Frequency Model Cut", lw=4)
# plt.plot(azi[peaks], zin[peaks], "x", label="Peaks", mew=5, ms=10)
# plt.plot(azi[peaks], results_half_n[1], '_', mew=5, ms=10, 
#      label="fwhm label {:3.3}".format(results_half_n[0][1]*0.12/301))
# plt.plot(azi[peaks], zin[peaks], "x", mew=5, ms=10,
#      label="Peak Sep {:3.3}, {:3.3}".
#          format(azi[peaks][1]-azi[peaks][0], azi[peaks][1]-azi[peaks][2]))

#DAVE
plt.plot(aziDAVE, zinDAVE, ':', color='#2ca02c', label="MODAL Model Cut", lw=3)
# plt.plot(aziDAVE[peaksDAVE], zinDAVE[peaksDAVE], "x", label="Peaks", mew=5, ms=10)
# plt.plot(aziDAVE[peaksDAVE], results_half_n_DAVE[1], '_', mew=5, ms=10, 
#      label="fwhm label {:3.3}".format(results_half_n_DAVE[0][1]*0.12/301))
# plt.plot(aziDAVE[peaksDAVE], zinDAVE[peaksDAVE], "x", mew=5, ms=10,
#      label="Peak Sep {:3.3}, {:3.3}".
#          format(aziDAVE[peaksDAVE][1]-aziDAVE[peaksDAVE][0], aziDAVE[peaksDAVE][1]-aziDAVE[peaksDAVE][2]))

#donny
plt.plot(aziDONNY, zinDONNY, '-.', color='#d62728', label="SCATTER Model Cut", lw=2)
#plt.plot(aziDONNY[peaksDONNY], zinDONNY[peaksDONNY], "x", label="Peaks", mew=5, ms=10)
#plt.plot(aziDONNY[peaksDONNY], results_half_n_DONNY[1], '_', mew=5, ms=10, 
     #label="fwhm label {:3.3}".format(results_half_n_DONNY[0][1]*0.12/301))
#plt.plot(aziDONNY[peaksDONNY], zinDONNY[peaksDONNY], "x", mew=5, ms=10,
     #label="Peak Sep {:3.3}, {:3.3}".
         #format(aziDONNY[peaksDONNY][1]-aziDONNY[peaksDONNY][0], aziDONNY[peaksDONNY][1]-aziDONNY[peaksDONNY][2]))

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Logarithmic Normalised Intensity (W)')
plt.title('Aperture Field Models on Focal Plane')
plt.grid(True)
plt.yscale('log')
#plt.savefig("/home/james/OneDrive/Thesis/Figures/figsc35/fpcutplacehold.png", bbox_inches='tight', facecolor='white')
```

```{python}
"""This seems too congruent/good.... :0"""
```

```{python}
"""test single horn on FP horn 113 is the test edge horn as before"""

from CSFPA_dataIO import IntensityCalcRAW

mrep = '/home/james/GRASPdata/MyTabSourceFIModel/Gaussian150GHz/MODALfiles/'
horn = 113

print(mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
file = mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
gausdata = pd.read_csv(file, sep='\t')
print(gausdata.shape)


GIx, GIy, GI = IntensityCalcRAW(file)
print(GI.shape)
gausdata.head()

```

```{python}
GI = np.array(GI)
xvals = np.array(gausdata['Xpos'])
yvals = np.array(gausdata['Ypos'])
```

```{python}
print(gausdata['Xpos'].shape, GI.shape)
print(xvals, xvals.shape)
```

```{python}
plt.figure(figsize=(16,8))

# plt.plot(pts[:,0][np.where(pts[:,1] == 0)], ampXvar[np.where(pts[:,1] == 0)]/max(ampXvar), color='#ff7f0e', 
#          linewidth=3, label=r'Scatter 0$\degree$ cut')
plt.plot(aziGAUSS, zinGAUSS, label="Gaussian Cut", lw=4)
plt.plot(azi, zi, label="Gaussian Cut with abberated cut", lw=4)

#plt.plot(xvals[np.where(yvals == 0)], GI[np.where(yvals == 0)]/max(GI), label='Horn 113 Gaussian')

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Logarithmic Normalised Intensity (W)')
plt.title('Aperture Field Models on Focal Plane')
plt.grid(True)
#plt.yscale('log')
"""okay this is not so simple because of the odd aberated radial cut for the synthetic image, 
must redo for horn"""

```

```{python}
"""probably should make a function of this abberated cut plot"""

def AbberatedCut(xdat, ydat, itdat, x0, y0, x1, y1, x2, y2, meshsize, prom, rel_height, norm=True, rpeaks=False):
    """it x and y dat should be same shape, points for cuts, meshsize"""

    mesh = np.zeros([1, meshsize, meshsize])
    mesh = makemeshgrid(np.array([xdat, ydat, itdat]), meshsize)

    azmin = min(xdat)
    azmax = max(xdat)
    elmin = min(ydat)
    elmax = max(ydat)
    
    gridlength = azmax - azmin

    X = np.linspace(azmin, azmax, meshsize)
    Y = np.linspace(elmax, elmin, meshsize)


    plt.figure(figsize=(16,12))
    plt.subplot(1,2,1)
    plt.imshow(mesh, aspect='equal')
    plt.grid(True)
    plt.plot([x0, x1], [y0, y1], 'ro-')
    plt.plot([x1, x2], [y1, y2], 'bo-')


    #x, y = np.linspace(x0, x1, 40), np.linspace(y0, y1, 40)
    xr = np.linspace(x0, x2, x2-x0)
    #xa, ya = np.linspace(x1, x2, 20), np.linspace(y1, y2, 20)
    yi = np.linspace(y0, y1, x1-x0)
    yj = np.linspace(y1, y2, x2-x1)

    #xr = np.append(x, xa)
    yr = np.append(yi, yj)

    plt.subplot(1,2,2)
    plt.imshow(mesh, aspect='equal', extent=[azmin, azmax, elmin, elmax])
    plt.grid(True)
    plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')
    plt.plot([X[x1], X[x2]], [Y[y1], Y[y2]], 'bo-')


    zi = mesh[xr.astype(np.int), yr.astype(np.int)]
    zi = scipy.ndimage.map_coordinates(np.transpose(mesh), np.vstack((xr,yr)))

    if norm == True:
        zi = zi/max(zi)
        
    #this version does a radial calculation for cut
    azi = np.linspace(-1*np.sqrt(X[x0]**2+(Y[y0])**2), np.sqrt(X[x2]**2+(Y[y2])**2), len(zi))
    peaks, _ = find_peaks(zi, prominence=prom)
    results_half = peak_widths(zi, peaks, rel_height=rel_height)


    plt.figure(figsize=(16,8))
    plt.plot(azi, zi, label="Cut", lw=4)
    plt.legend(loc='upper left', fontsize=15)
    plt.xlabel('Focal Plane Cut (Radial) (m)')
    plt.ylabel('Normalised Intensity (W)')
    plt.title('blah (blah)')
    
    if rpeaks == True:
        plt.plot(azi[peaks], zi[peaks], "x", label="Peaks", mew=5, ms=10)
        plt.plot(azi[peaks], results_half[1], '_', mew=5, ms=10, 
             label="fwhm label {:3.3}".format(results_half[0][1]*gridlength/meshsize))
        plt.plot(azi[peaks], zi[peaks], "x", mew=5, ms=10,
             label="Peak Sep {:3.3}, {:3.3}".
                 format(azi[peaks][1]-azi[peaks][0], azi[peaks][1]-azi[peaks][2]))
        return azi, zi, peaks, results_half
    else:
        return azi, zi
```

```{python}
x0, y0 = 25, 247
x1, y1 = 174, 125
x2, y2 = 219, 50

azi, zi = AbberatedCut(xvals, yvals, GI, x0, y0, x1, y1, x2, y2, 
                                            301, 0.2, 0.5, True, False)
```

```{python}
# """pretest data"""
# print(it.shape, itDAVE.shape)

# """load the MODAL files for daves Model"""
# qbrepDAVE = '/home/james/GRASPdata/DavesTabSourceFIModel/MODALfiles/'
# filesDAVE = sorted(glob.glob(qbrepDAVE+'*.qb'))
# print('read', len(filesDAVE), 'DAVE files')

# """load the MODAL files"""
# qbrep = '/home/james/GRASPdata/MyTabSourceFIModel/150GHz/MODALfiles/'
# files = sorted(glob.glob(qbrep+'*.qb'))
# print('read', len(files), 'My files')

# """load Donnys SCATTER version"""
# qbrepDONNY = '/media/james/DATA/LaptopFiles/FIgraspFiles/MODALversions/'
# filesDONNY = sorted(glob.glob(qbrepDONNY+'*.qb'))
# print('read', len(filesDONNY), 'Donny files')
# donnydat = pd.read_csv(filesDONNY[0], sep='\t')
# print(donnydat.shape)
# donnydat.head()
```

```{python}
"""now do for all models for horn 113 then a central horn"""

mrep = '/home/james/GRASPdata/MyTabSourceFIModel/Gaussian150GHz/MODALfiles/'
horn = 113

# print(mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb')
# file = mrep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
# gausdata = pd.read_csv(file, sep='\t')

# GIx, GIy, GI = IntensityCalcRAW(file)

x0, y0 = 25, 247
x1, y1 = 174, 125
x2, y2 = 219, 50

reps = [mrep, qbrep, qbrepDAVE, qbrepDONNY]
aziA = np.zeros(194)
ziA = np.zeros(194)

for rep in reps:
    
    file = rep+'FP_planar_grid_horn'+str(horn)+'_150_GHz_Mstyle.qb'
    print(file)

    dat = pd.read_csv(file, sep='\t')
    GIx, GIy, GI = IntensityCalcRAW(file)
    
    azi, zi = AbberatedCut(np.array(dat['Xpos']), np.array(dat['Ypos']), np.array(GI), 
                                    x0, y0, x1, y1, x2, y2, 301, 0.2, 0.5, True, False);
    
    aziA = np.vstack((aziA, azi))
    ziA = np.vstack((ziA, zi))
    
print(aziA.shape, ziA.shape)

horn2 = 190

for rep in reps:
    
    file = rep+'FP_planar_grid_horn'+str(horn2)+'_150_GHz_Mstyle.qb'
    print(file)

    dat = pd.read_csv(file, sep='\t')
    GIx, GIy, GI = IntensityCalcRAW(file)
    
    azi, zi = AbberatedCut(np.array(dat['Xpos']), np.array(dat['Ypos']), np.array(GI), 
                                    x0, y0, x1, y1, x2, y2, 301, 0.2, 0.5, True, False);
    
    aziA = np.vstack((aziA, azi))
    ziA = np.vstack((ziA, zi))
```

```{python}
plt.figure(figsize=(16,8))
#keep blue for gaussian...
plt.plot(aziGAUSS, zinGAUSS, label="Gaussian Cut", lw=4)
#MINE
plt.plot(azi, zin, color='#ff7f0e', label="Frequency Model Cut", lw=4)

#DAVE
plt.plot(aziDAVE, zinDAVE, ':', color='#2ca02c', label="MODAL Model Cut", lw=3)

#donny
plt.plot(aziDONNY, zinDONNY, '-.', color='#d62728', label="SCATTER Model Cut", lw=2)

"""now plot single horn envelopes h113"""
plt.plot(aziA[1], ziA[1], '-.', color='k', label="Gaussian Envelope Horn 113", lw=2)
plt.plot(aziA[2], ziA[2], '-.', color='tab:green', label="Freq Model Envelope Horn 113", lw=2)
plt.plot(aziA[3], ziA[3], '-.', color='slateblue', label="MODAL Model Envelope Horn 113", lw=2)
plt.plot(aziA[4], ziA[4], '-.', color='tomato', label="SCATTER Model Envelope Horn 113", lw=2)

"""now plot single horn envelopes h190"""
plt.plot(aziA[5], ziA[5], '-.', label="Gaussian Envelope Horn 190", lw=2)
plt.plot(aziA[6], ziA[6], '-.', label="Freq Model Envelope Horn 190", lw=2)
plt.plot(aziA[7], ziA[7], '-.', label="MODAL Model Envelope Horn 190", lw=2)
plt.plot(aziA[8], ziA[8], '-.', label="SCATTER Model Envelope Horn 190", lw=2)

plt.legend(loc='upper left', fontsize=15)
plt.xlabel('Focal Plane Cut (Radial) (m)')
plt.ylabel('Normalised Intensity (W)')
plt.title('Aperture Field Models on Focal Plane')
plt.grid(True)
plt.yscale('log')
plt.ylim([1e-2, 0])
```

```{python}

```
